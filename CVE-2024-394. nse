-- Usage: nmap -p <port> --script xz-vuln.nse <target>

description = [[
Checks for xz compression utility vulnerability (CVE-2024-3094) in versions 5.6.0 and 5.6.1.
]]

-- Version 0.3
-- Created 31/03/2024 by ChatGPT

-- portrule to restrict script to specific port(s)
portrule = function(host, port)
  return port.protocol == "tcp" and port.number == 22
end

-- action function to perform the vulnerability check
action = function(host, port)
  local cmd = "xz --version"
  local handle = io.popen(cmd)
  local result = handle:read("*a")
  handle:close()

  if result:find("5.6.0") or result:find("5.6.1") then
    return ("Vulnerability found on %s:%d"):format(host.ip, port.number)
  else
    return ("No vulnerability found on %s:%d"):format(host.ip, port.number)
  end
end
